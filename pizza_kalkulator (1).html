<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üçï Pizza Alapanyag Kalkul√°tor</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: Arial, sans-serif; background: #f0f4f8; color: #222; }
  header { background: #1F3864; color: white; padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; gap: 14px; flex-wrap: wrap; }
  header h1 { font-size: 20px; }
  .btn { padding: 8px 18px; border-radius: 8px; border: none; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.15s; }
  .btn-settings { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); }
  .btn-settings:hover { background: rgba(255,255,255,0.25); }
  .btn-primary { background: #2E5DA6; color: white; }
  .btn-primary:hover { background: #1F3864; }
  .btn-danger { background: #c0392b; color: white; }
  .btn-danger:hover { background: #a93226; }
  .btn-success { background: #27ae60; color: white; }
  .btn-success:hover { background: #1e8449; }
  .btn-warn { background: #e67e22; color: white; }
  .btn-warn:hover { background: #ca6f1e; }
  .btn-sm { padding: 5px 12px; font-size: 12px; }
  .btn-xs { padding: 3px 8px; font-size: 11px; }

  .container { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
  .card { background: white; border-radius: 10px; padding: 20px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; }
  .card h3 { color: #1F3864; font-size: 15px; margin-bottom: 14px; }

  .mode-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
  .mode-tab { flex: 1; min-width: 130px; padding: 10px 14px; border: 2px solid #dde3f0; border-radius: 10px; background: white; cursor: pointer; text-align: center; font-size: 13px; font-weight: bold; color: #888; transition: all 0.15s; }
  .mode-tab:hover { border-color: #2E5DA6; color: #2E5DA6; }
  .mode-tab.active { border-color: #1F3864; background: #1F3864; color: white; }
  .mode-tab .sub { font-size: 10px; font-weight: normal; opacity: 0.8; display: block; margin-top: 2px; }

  .input-panels { display: flex; gap: 14px; flex-wrap: wrap; }
  .input-panel { flex: 1; min-width: 210px; border-radius: 10px; padding: 16px 18px; border: 2px solid #dde3f0; }
  .input-panel.panel-45 { border-color: #2E5DA6; background: #f0f4ff; }
  .input-panel.panel-32 { border-color: #E8A000; background: #fff8e1; }
  .input-panel h4 { font-size: 13px; margin-bottom: 10px; }
  .panel-45 h4 { color: #1F3864; }
  .panel-32 h4 { color: #7A4F00; }
  .dual-input { display: flex; flex-direction: column; gap: 8px; }
  .input-block { border: 2px solid #dde3f0; border-radius: 8px; padding: 10px 14px; background: white; }
  .input-block.active-45 { border-color: #2E5DA6; background: #e8f0fe; }
  .input-block.active-32 { border-color: #E8A000; background: #fff3cd; }
  .input-block label { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; letter-spacing: 0.4px; display: block; margin-bottom: 4px; }
  .input-row-inner { display: flex; align-items: center; gap: 6px; }
  .input-block input[type=number] { font-size: 20px; font-weight: bold; color: #1F3864; border: none; outline: none; background: transparent; width: 100%; }
  .input-block .suffix { font-size: 12px; color: #888; white-space: nowrap; }
  .or-div { text-align: center; font-size: 11px; color: #aaa; font-weight: bold; }

  .summary-bar { background: #1F3864; color: white; border-radius: 10px; padding: 14px 20px; margin-bottom: 20px; display: flex; gap: 24px; flex-wrap: wrap; align-items: center; }
  .summary-item .s-label { font-size: 10px; opacity: 0.7; margin-bottom: 2px; }
  .summary-item .s-val { font-size: 18px; font-weight: bold; }
  .summary-item.highlight .s-val { color: #FFD700; }
  .summary-sep { width: 1px; background: rgba(255,255,255,0.2); align-self: stretch; min-height: 36px; }

  .gomboc-controls { display: flex; gap: 24px; align-items: center; flex-wrap: wrap; }
  .slider-side { display: flex; flex-direction: column; gap: 6px; }
  .slider-side label { font-size: 13px; font-weight: bold; color: #555; }
  input[type=range] { width: 200px; accent-color: #2E5DA6; cursor: pointer; }
  .gomboc-vals { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
  .gv { border-radius: 8px; padding: 8px 14px; text-align: center; min-width: 84px; border: 2px solid #2E5DA6; background: #f0f4ff; }
  .gv.tk { border-color: #E8A000; background: #fff8e1; }
  .gv.g32 { border-color: #E8A000; background: #fff8e1; }
  .gv .glabel { font-size: 9px; color: #888; margin-bottom: 1px; }
  .gv .num { font-size: 18px; font-weight: bold; color: #1F3864; }
  .gv.tk .num, .gv.g32 .num { color: #7A4F00; }
  .gv .pct { font-size: 10px; color: #2E5DA6; font-weight: bold; }
  .gv.tk .pct, .gv.g32 .pct { color: #E8A000; }
  .vs { font-size: 14px; color: #ccc; font-weight: bold; }
  .reset-btn { background: #f0f4f8; border: 1px solid #ccc; border-radius: 6px; padding: 5px 12px; font-size: 11px; cursor: pointer; color: #555; }
  .reset-btn:hover { background: #dde5f0; }

  .section { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; }
  .section-title { background: #2E5DA6; color: white; padding: 10px 18px; font-weight: bold; font-size: 14px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: #2E5DA6; color: white; padding: 8px 12px; text-align: center; font-size: 11px; }
  th:first-child { text-align: left; }
  td { padding: 7px 12px; border-bottom: 1px solid #eee; }
  td:first-child { font-weight: 500; }
  td:not(:first-child) { text-align: center; }
  tr:hover { background: #e8f0fe; }
  .val { font-weight: bold; color: #1F3864; }
  .ceil { font-weight: bold; color: #375623; background: #E2EFDA; border-radius: 5px; padding: 2px 7px; display: inline-block; }
  .unit { color: #888; font-size: 10px; margin-left: 2px; }
  .dash { color: #bbb; }
  .group-header td { font-weight: bold; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; padding: 7px 12px 5px; border-bottom: none; color: white; }
  .group-gomboc td { background: #1F3864; }
  .group-egyeb-pizza td { background: #8E44AD; }
  .group-fix td { background: #2E5DA6; }
  .row-gomboc { background: #fff8e1 !important; }
  .row-gomboc td:first-child { color: #7A4F00; font-weight: bold; }
  .row-fix { background: #e8f0fe !important; }
  .row-egyeb-pizza { background: #f5eeff !important; }
  .row-normal { background: white; }
  .row-normal:nth-child(even) { background: #f7f9fc; }

  .pizza-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(185px, 1fr)); gap: 8px; padding: 14px; }
  .pizza-card { background: #f7f9fc; border: 1px solid #dde3f0; border-radius: 8px; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; }
  .pizza-card.custom { border-color: #8E44AD; background: #f9f0ff; }
  .pizza-name { font-size: 12px; font-weight: 500; }
  .pizza-dbs { text-align: right; }
  .pizza-db45 { font-size: 14px; font-weight: bold; color: #2E5DA6; }
  .pizza-db32 { font-size: 11px; color: #E8A000; font-weight: bold; }
  .pizza-pct { font-size: 10px; color: #888; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
  .modal-overlay.hidden { display: none; }
  .modal { background: white; border-radius: 14px; width: 100%; max-width: 760px; overflow: hidden; box-shadow: 0 8px 40px rgba(0,0,0,0.2); }
  .modal-header { background: #1F3864; color: white; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
  .modal-header h2 { font-size: 17px; }
  .modal-close { background: none; border: none; color: white; font-size: 22px; cursor: pointer; opacity: 0.7; }
  .modal-close:hover { opacity: 1; }
  .modal-tabs { display: flex; border-bottom: 2px solid #eee; }
  .modal-tab { flex: 1; padding: 12px; text-align: center; font-size: 13px; font-weight: bold; color: #888; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
  .modal-tab.active { color: #1F3864; border-bottom-color: #1F3864; }
  .modal-body { padding: 20px 24px; max-height: 72vh; overflow-y: auto; }
  .modal-footer { padding: 14px 24px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap; }

  /* √År tab */
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .setting-item { display: flex; flex-direction: column; gap: 6px; }
  .setting-item label { font-size: 12px; font-weight: bold; color: #555; }
  .setting-item input { border: 2px solid #dde3f0; border-radius: 8px; padding: 10px 14px; font-size: 16px; font-weight: bold; color: #1F3864; outline: none; width: 100%; }
  .setting-item input:focus { border-color: #2E5DA6; }
  .setting-item .s-hint { font-size: 11px; color: #888; }

  /* Pizza tab */
  .pizza-settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; }
  .arany-ossz { font-size: 13px; font-weight: bold; }
  .arany-ossz.ok { color: #27ae60; }
  .arany-ossz.err { color: #c0392b; }
  .pizza-setting-row { display: flex; align-items: center; gap: 10px; padding: 9px 0; border-bottom: 1px solid #f0f0f0; }
  .pizza-toggle { position: relative; width: 38px; height: 22px; flex-shrink: 0; }
  .pizza-toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-slider { position: absolute; inset: 0; background: #ccc; border-radius: 22px; cursor: pointer; transition: 0.2s; }
  .toggle-slider:before { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; top: 3px; background: white; border-radius: 50%; transition: 0.2s; }
  .pizza-toggle input:checked + .toggle-slider { background: #27ae60; }
  .pizza-toggle input:checked + .toggle-slider:before { transform: translateX(16px); }
  .pizza-setting-name { flex: 1; font-size: 13px; font-weight: 500; }
  .pizza-setting-name.disabled { color: #bbb; text-decoration: line-through; }
  .pizza-setting-name .custom-badge { font-size: 10px; background: #8E44AD; color: white; border-radius: 4px; padding: 1px 5px; margin-left: 5px; }
  .arany-input-wrap { display: flex; align-items: center; gap: 4px; }
  .arany-input { width: 68px; border: 2px solid #dde3f0; border-radius: 6px; padding: 5px 8px; font-size: 13px; font-weight: bold; color: #1F3864; text-align: right; outline: none; }
  .arany-input:focus { border-color: #2E5DA6; }
  .arany-input:disabled { background: #f5f5f5; color: #ccc; border-color: #eee; }
  .norm-btn { background: #2E5DA6; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 11px; cursor: pointer; }
  .norm-btn:hover { background: #1F3864; }
  .pizza-recept-btn { background: #f0f4f8; border: 1px solid #ccc; border-radius: 6px; padding: 4px 10px; font-size: 11px; cursor: pointer; color: #555; white-space: nowrap; }
  .pizza-recept-btn:hover { background: #e0e8f0; }

  /* Recept szerkeszt≈ë */
  .recept-form { background: #f8f9fa; border-radius: 10px; padding: 16px; margin-top: 4px; border: 2px solid #e0e0e0; }
  .recept-form h4 { font-size: 14px; color: #1F3864; margin-bottom: 12px; }
  .recept-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
  .recept-row select, .recept-row input[type=text] { flex: 2; border: 1.5px solid #dde3f0; border-radius: 6px; padding: 7px 10px; font-size: 13px; outline: none; min-width: 120px; }
  .recept-row input[type=number] { width: 80px; border: 1.5px solid #dde3f0; border-radius: 6px; padding: 7px 10px; font-size: 13px; outline: none; }
  .recept-row select:focus, .recept-row input:focus { border-color: #2E5DA6; }
  .recept-row .del-btn { background: #fadbd8; border: none; border-radius: 6px; padding: 7px 10px; cursor: pointer; font-size: 13px; color: #c0392b; }
  .recept-row .del-btn:hover { background: #f1948a; }
  .add-anyag-btn { background: #e8f8f0; border: 1.5px dashed #27ae60; border-radius: 6px; padding: 7px 14px; font-size: 12px; cursor: pointer; color: #27ae60; font-weight: bold; width: 100%; margin-top: 4px; }
  .add-anyag-btn:hover { background: #d5f5e3; }

  /* √öj pizza form */
  .new-pizza-form { background: #f0fff4; border: 2px dashed #27ae60; border-radius: 10px; padding: 16px; margin-top: 12px; }
  .new-pizza-form h4 { color: #1a5c32; font-size: 14px; margin-bottom: 12px; }
  .form-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 10px; }
  .form-field { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 140px; }
  .form-field label { font-size: 11px; font-weight: bold; color: #555; }
  .form-field input { border: 2px solid #dde3f0; border-radius: 7px; padding: 8px 12px; font-size: 14px; outline: none; }
  .form-field input:focus { border-color: #27ae60; }

  footer { text-align: center; color: #aaa; font-size: 11px; padding: 20px; }

  /* PROFILOK */
  .profil-bar { background: #162d54; padding: 8px 32px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  .profil-label { color: rgba(255,255,255,0.6); font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
  .profil-btn { padding: 6px 14px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.2); background: transparent; color: rgba(255,255,255,0.7); font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .profil-btn:hover { border-color: rgba(255,255,255,0.5); color: white; }
  .profil-btn.active { background: white; color: #1F3864; border-color: white; }
  .profil-btn.uj-profil { border-style: dashed; color: rgba(255,255,255,0.5); }
  .profil-btn.uj-profil:hover { color: white; border-color: white; }
  .profil-lista { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
  .profil-sor { display: flex; align-items: center; gap: 10px; background: #f7f9fc; border-radius: 8px; padding: 10px 14px; border: 2px solid #eee; }
  .profil-sor.aktiv { border-color: #2E5DA6; background: #f0f4ff; }
  .profil-nev-input { flex: 1; border: 1.5px solid #dde3f0; border-radius: 6px; padding: 6px 10px; font-size: 14px; font-weight: bold; outline: none; background: transparent; }
  .profil-nev-input:focus { border-color: #2E5DA6; background: white; }
  .profil-aktiv-badge { font-size: 10px; background: #2E5DA6; color: white; border-radius: 10px; padding: 2px 8px; white-space: nowrap; }
  .profil-default-badge { font-size: 10px; background: #888; color: white; border-radius: 10px; padding: 2px 8px; white-space: nowrap; }
  .uj-profil-form { background: #f0fff4; border: 2px dashed #27ae60; border-radius: 10px; padding: 16px; }
  .uj-profil-form h4 { color: #1a5c32; font-size: 14px; margin-bottom: 12px; }
</style>
</head>
<body>

<header>
  <div>
    <h1>üçï Pizza Alapanyag Kalkul√°tor</h1>
    <div style="font-size:12px;opacity:0.7;">45cm szelet ¬∑ 32cm eg√©sz pizza ¬∑ kombin√°lt m√≥d</div>
  </div>
  <button class="btn btn-settings" onclick="openSettings()">‚öôÔ∏è Be√°ll√≠t√°sok</button>
</header>

<div class="profil-bar" id="profil-bar"></div>

<div class="container">
  <div class="mode-tabs">
    <div class="mode-tab active" id="tab-45" onclick="setMod('45')">üçï 45cm-es<span class="sub">Szeletenk√©nt</span></div>
    <div class="mode-tab" id="tab-32" onclick="setMod('32')">ü´ì 32cm-es<span class="sub">Eg√©sz pizza</span></div>
    <div class="mode-tab" id="tab-kombi" onclick="setMod('kombi')">üîÄ Kombin√°lt<span class="sub">Mindk√©t m√©ret</span></div>
  </div>

  <div class="card">
    <h3 id="input-title">üìä Mennyi √°ru kell?</h3>
    <div class="input-panels" id="input-panels"></div>
  </div>

  <div class="summary-bar" id="summary-bar"></div>

  <div class="card">
    <h3>ü´ì Gomb√≥c ar√°ny (sima / TK)</h3>
    <div style="display:flex;gap:16px;flex-wrap:wrap;">
      <div style="flex:1;min-width:220px;background:#f0f4ff;border:2px solid #2E5DA6;border-radius:10px;padding:14px 18px;">
        <div style="font-size:12px;font-weight:bold;color:#2E5DA6;margin-bottom:10px;">üçï 45cm-es</div>
        <div class="slider-side">
          <label>Sima: <strong id="sima-pct-lbl-45">70%</strong> &nbsp; TK: <strong id="tk-pct-lbl-45">30%</strong></label>
          <input type="range" id="sima-slider-45" min="0" max="100" value="70" oninput="sliderValtozas45(this.value)">
          <button class="reset-btn" onclick="resetArany45()">‚Ü∫ 70% / 30%</button>
        </div>
        <div class="gomboc-vals" id="gomboc-vals-45" style="margin-top:10px;"></div>
      </div>
      <div style="flex:1;min-width:220px;background:#fff8e1;border:2px solid #E8A000;border-radius:10px;padding:14px 18px;">
        <div style="font-size:12px;font-weight:bold;color:#7A4F00;margin-bottom:10px;">ü´ì 32cm-es</div>
        <div class="slider-side">
          <label>Sima: <strong id="sima-pct-lbl-32">95%</strong> &nbsp; TK: <strong id="tk-pct-lbl-32">5%</strong></label>
          <input type="range" id="sima-slider-32" min="0" max="100" value="95" oninput="sliderValtozas32(this.value)">
          <button class="reset-btn" onclick="resetArany32()">‚Ü∫ 95% / 5%</button>
        </div>
        <div class="gomboc-vals" id="gomboc-vals-32" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">üçï Pizza t√≠pusonk√©nti bont√°s</div>
    <div class="pizza-grid" id="pizza-grid"></div>
  </div>

  <div class="section">
    <div class="section-title">üì¶ Alapanyag sz√ºks√©glet</div>
    <table>
      <thead><tr>
        <th>Alapanyag</th><th>Egys√©g</th><th>Sz√ºks√©ges</th><th>Alapegys√©g</th><th>Rendel√©shez</th>
      </tr></thead>
      <tbody id="anyag-tabla"></tbody>
    </table>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay hidden" id="settings-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>‚öôÔ∏è Be√°ll√≠t√°sok</h2>
      <button class="modal-close" onclick="closeSettings()">‚úï</button>
    </div>
    <div class="modal-tabs">
      <div class="modal-tab active" id="mtab-arak" onclick="setModalTab('arak')">üí∞ √Årak</div>
      <div class="modal-tab" id="mtab-pizzak" onclick="setModalTab('pizzak')">üçï Pizz√°k & ar√°nyok</div>
      <div class="modal-tab" id="mtab-profilok" onclick="setModalTab('profilok')">üë§ Profilok</div>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="resetAll()">‚Ü∫ Alap√©rtelmezett</button>
      <button class="btn btn-success btn-sm" onclick="closeSettings()">‚úì Ment√©s & bez√°r√°s</button>
    </div>
  </div>
</div>

<footer id="footer-bar"></footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADATOK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULTS = { szeletAr45: 1199, pizzaAr32: 5600, szeletPerGomboc: 8 };
let cfg = { ...DEFAULTS };
let mod = '45', modalTab = 'arak';
let simaArany45 = 70, simaArany32 = 95;
let db45 = 100, db32 = 0;
let receptSzerkesztoIdx = null;

// Alapanyag master lista: { nev, egys, alap, ae }
// egys: g vagy db | alap: kerek√≠t√©si egys√©g | ae: egys√©g neve
const defaultAlapanyagok = [
  { nev: "P sz√≥sz",               egys: "g",  alap: 10000, ae: "g"  },
  { nev: "Reszelt Mozzarella",     egys: "g",  alap: 2500,  ae: "g"  },
  { nev: "P Sonka Cotto",          egys: "g",  alap: 2000,  ae: "g"  },
  { nev: "Funghi mix zacsk√≥",      egys: "db", alap: 1,     ae: "db" },
  { nev: "P Spinata Calabra",      egys: "g",  alap: 1000,  ae: "g"  },
  { nev: "Gorgonzola",             egys: "g",  alap: 500,   ae: "g"  },
  { nev: "Ricotta",                egys: "g",  alap: 250,   ae: "g"  },
  { nev: "Parmez√°nsajt",           egys: "g",  alap: 1000,  ae: "g"  },
  { nev: "Spen√≥t",                 egys: "db", alap: 1,     ae: "db" },
  { nev: "P Szal√°mi Napolitana",   egys: "g",  alap: 500,   ae: "g"  },
  { nev: "Tartufata sz√≥sz",        egys: "db", alap: 1,     ae: "db" },
  { nev: "P Z√∂lds√©g mix",          egys: "g",  alap: 400,   ae: "g"  },
  { nev: "Nutella",                egys: "g",  alap: null,  ae: null },
  { nev: "Kis Tonhalkonzerv",      egys: "db", alap: 1,     ae: "db" },
  { nev: "Ol√≠vabogy√≥",             egys: "g",  alap: 160,   ae: "g"  },
  { nev: "Pepperoni szal√°mi",      egys: "g",  alap: 500,   ae: "g"  },
  { nev: "Szupercs√≠p≈ës pepperoni", egys: "g",  alap: 360,   ae: "g"  },
  { nev: "Lilahagyma",             egys: "g",  alap: null,  ae: null },
];

// Pizza lista: { nev, arany, aktiv, custom, recept: [{anyag, menny, egys}] }
// Menny: grammban (g) vagy darabban (db) ‚Äì a 45cm-es recepthez
// 32cm = fele
const defaultPizzak = [
  { nev: "Margherita",          arany: 18.02, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:240,egys:"g"},{anyag:"Reszelt Mozzarella",menny:230,egys:"g"}] },
  { nev: "Prosciutto",          arany: 13.90, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Sonka Cotto",menny:150,egys:"g"}] },
  { nev: "SalaMe Dolce",        arany: 12.16, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Szal√°mi Napolitana",menny:100,egys:"g"}] },
  { nev: "Quattro",             arany:  8.17, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:150,egys:"g"},{anyag:"Ricotta",menny:100,egys:"g"},{anyag:"Gorgonzola",menny:80,egys:"g"},{anyag:"Parmez√°nsajt",menny:25,egys:"g"}] },
  { nev: "Popeye",              arany:  6.52, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:180,egys:"g"},{anyag:"Ricotta",menny:50,egys:"g"},{anyag:"Spen√≥t",menny:150,egys:"g"},{anyag:"Parmez√°nsajt",menny:25,egys:"g"}] },
  { nev: "Diavola",             arany:  6.38, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Spinata Calabra",menny:80,egys:"g"}] },
  { nev: "Prosciutto e Funghi", arany:  5.13, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Sonka Cotto",menny:120,egys:"g"},{anyag:"Funghi mix zacsk√≥",menny:100,egys:"g"}] },
  { nev: "Tartufata",           arany:  4.75, aktiv: true, custom: false,
    recept: [{anyag:"Funghi mix zacsk√≥",menny:200,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"Tartufata sz√≥sz",menny:160,egys:"g"}] },
  { nev: "Salami & Zola",       arany:  4.34, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Spinata Calabra",menny:80,egys:"g"},{anyag:"Gorgonzola",menny:70,egys:"g"}] },
  { nev: "Pepperoni",           arany:  3.49, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"Pepperoni szal√°mi",menny:100,egys:"g"}] },
  { nev: "Alessandro Speciale", arany:  2.84, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"P Sonka Cotto",menny:80,egys:"g"},{anyag:"Pepperoni szal√°mi",menny:80,egys:"g"},{anyag:"Gorgonzola",menny:60,egys:"g"}] },
  { nev: "Super Piccante",      arany:  1.42, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:180,egys:"g"},{anyag:"Szupercs√≠p≈ës pepperoni",menny:120,egys:"g"}] },
  { nev: "Oliva",               arany:  0.89, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:180,egys:"g"},{anyag:"Funghi mix zacsk√≥",menny:100,egys:"g"},{anyag:"Ol√≠vabogy√≥",menny:80,egys:"g"}] },
  { nev: "Rio Tonhalas",        arany:  0.53, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:180,egys:"g"},{anyag:"Kis Tonhalkonzerv",menny:1,egys:"db"},{anyag:"Ol√≠vabogy√≥",menny:50,egys:"g"}] },
  { nev: "Funghi",              arany:  0.37, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:220,egys:"g"},{anyag:"Reszelt Mozzarella",menny:200,egys:"g"},{anyag:"Funghi mix zacsk√≥",menny:160,egys:"g"}] },
  { nev: "Verdure",             arany:  0.35, aktiv: true, custom: false,
    recept: [{anyag:"P sz√≥sz",menny:240,egys:"g"},{anyag:"P Z√∂lds√©g mix",menny:400,egys:"g"}] },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFIL RENDSZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function ujProfilAdat(nev, forrasPizzak) {
  return {
    id: Date.now() + Math.random(),
    nev: nev,
    pizzak: forrasPizzak.map(p => deepCopy(p))
  };
}

const defaultProfil = ujProfilAdat('√Åltal√°nos', defaultPizzak);
let profilok = [defaultProfil];
let aktivProfilId = defaultProfil.id;

function aktivProfil() { return profilok.find(p => p.id === aktivProfilId); }

function profilValtas(id) {
  aktivProfilId = id;
  pizzak = aktivProfil().pizzak;
  receptSzerkesztoIdx = null;
  renderProfilBar();
  renderModalBody();
  frissit();
}

function renderProfilBar() {
  const bar = document.getElementById('profil-bar');
  let h = '<span class="profil-label">Profil:</span>';
  profilok.forEach(p => {
    h += `<button class="profil-btn ${p.id===aktivProfilId?'active':''}" onclick="profilValtas(${p.id})">${p.nev}</button>`;
  });
  h += `<button class="profil-btn uj-profil" onclick="openSettings();setModalTab('profilok')">+ √öj profil</button>`;
  bar.innerHTML = h;
}

let pizzak = aktivProfil().pizzak;
let alapanyagok = defaultAlapanyagok.map(a => ({...a}));

function deepCopy(o) { return JSON.parse(JSON.stringify(o)); }
function aktivPizzak() { return pizzak.filter(p => p.aktiv); }
function osszeArany() { return Math.round(aktivPizzak().reduce((s,p) => s+p.arany, 0)*100)/100; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALAPANYAG √ñSSZES√çT≈ê SZ√ÅM√çT√ÅS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function szamolAlapanyagok() {
  // Minden alapanyaghoz √∂sszegy≈±jtj√ºk a sz√ºks√©gletet
  // db egys√©g≈± alapanyagokn√°l (pl. Funghi mix zacsk√≥, Spen√≥t, Tartufata) a menny grammban √©rtend≈ë, osztani kell a csomag gramm s√∫ly√°val
  const csomagSuly = {
    "Funghi mix zacsk√≥": 1800,
    "Spen√≥t": 1800,
    "Tartufata sz√≥sz": 1200,
  };

  const ossz = {}; // anyagnev -> { ertek_g, egys }

  aktivPizzak().forEach(pizza => {
    const db45_pizza = db45 * pizza.arany / 100;
    const db32_pizza = db32 * pizza.arany / 100;

    pizza.recept.forEach(sor => {
      if (!ossz[sor.anyag]) ossz[sor.anyag] = 0;
      // 45cm: teljes menny, 32cm: fele
      ossz[sor.anyag] += db45_pizza * sor.menny + db32_pizza * sor.menny * 0.5;
    });
  });

  // Alapanyag adatok √∂ssze√°ll√≠t√°sa
  const eredmeny = [];
  const feldolgozott = new Set();

  // V√©gigmegy√ºnk az alapanyag master list√°n (sorrend√©rt)
  alapanyagok.forEach(a => {
    if (ossz[a.nev] === undefined) return;
    feldolgozott.add(a.nev);
    let ertek = Math.round(ossz[a.nev]);
    // Ha db egys√©g≈± √©s gramm alap√∫ a recept ‚Üí √°tv√°lt√°s
    if (a.egys === "db" && csomagSuly[a.nev]) {
      ertek = Math.round(ossz[a.nev] / csomagSuly[a.nev] * 100) / 100;
    }
    eredmeny.push({ nev: a.nev, egys: a.egys, ertek, alap: a.alap, ae: a.ae, custom: false });
  });

  // Egy√©ni pizza alapanyagok amik nincsenek a master list√°n
  Object.keys(ossz).forEach(nev => {
    if (feldolgozott.has(nev)) return;
    eredmeny.push({ nev, egys: "g", ertek: Math.round(ossz[nev]), alap: null, ae: null, custom: true });
  });

  return eredmeny;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// M√ìD, INPUT, SLIDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMod(m) {
  mod = m;
  ['45','32','kombi'].forEach(t => document.getElementById('tab-'+t).classList.toggle('active', t===m));
  if (m==='45') db32=0;
  if (m==='32') db45=0;
  renderInputs(); frissit();
}

function renderInputs() {
  const cont = document.getElementById('input-panels');
  let h = '';
  if (mod !== '32') h += panel45Html();
  if (mod === 'kombi') h += `<div style="display:flex;align-items:center;padding:0 6px;font-size:20px;color:#ccc;font-weight:bold;">+</div>`;
  if (mod !== '45') h += panel32Html();
  cont.innerHTML = h;
}

function panel45Html() {
  return `<div class="input-panel panel-45">
    <h4>üçï 45cm-es ¬∑ ${fmt(cfg.szeletAr45)} Ft/szelet</h4>
    <div class="dual-input">
      <div class="input-block active-45"><label>Darabsz√°m</label>
        <div class="input-row-inner"><input type="number" id="inp45-db" value="${db45||''}" min="0" placeholder="db" oninput="inputDb45()"><span class="suffix">db pizza</span></div></div>
      <div class="or-div">VAGY</div>
      <div class="input-block active-45"><label>Forgalom</label>
        <div class="input-row-inner"><input type="number" id="inp45-ft" value="${db45?db45*cfg.szeletPerGomboc*cfg.szeletAr45:''}" min="0" placeholder="Ft" oninput="inputFt45()"><span class="suffix">Ft</span></div></div>
    </div></div>`;
}

function panel32Html() {
  return `<div class="input-panel panel-32">
    <h4>ü´ì 32cm-es ¬∑ ${fmt(cfg.pizzaAr32)} Ft/pizza</h4>
    <div class="dual-input">
      <div class="input-block active-32"><label>Darabsz√°m</label>
        <div class="input-row-inner"><input type="number" id="inp32-db" value="${db32||''}" min="0" placeholder="db" oninput="inputDb32()"><span class="suffix">db pizza</span></div></div>
      <div class="or-div">VAGY</div>
      <div class="input-block active-32"><label>Forgalom</label>
        <div class="input-row-inner"><input type="number" id="inp32-ft" value="${db32?db32*cfg.pizzaAr32:''}" min="0" placeholder="Ft" oninput="inputFt32()"><span class="suffix">Ft</span></div></div>
    </div></div>`;
}

function inputDb45() { db45=Math.ceil(parseFloat(document.getElementById('inp45-db').value)||0); const el=document.getElementById('inp45-ft'); if(el) el.value=db45>0?db45*cfg.szeletPerGomboc*cfg.szeletAr45:''; frissit(); }
function inputFt45() { const ft=parseFloat(document.getElementById('inp45-ft').value)||0; db45=Math.ceil(ft/cfg.szeletAr45/cfg.szeletPerGomboc); const el=document.getElementById('inp45-db'); if(el) el.value=db45>0?db45:''; frissit(); }
function inputDb32() { db32=Math.ceil(parseFloat(document.getElementById('inp32-db').value)||0); const el=document.getElementById('inp32-ft'); if(el) el.value=db32>0?db32*cfg.pizzaAr32:''; frissit(); }
function inputFt32() { const ft=parseFloat(document.getElementById('inp32-ft').value)||0; db32=Math.ceil(ft/cfg.pizzaAr32); const el=document.getElementById('inp32-db'); if(el) el.value=db32>0?db32:''; frissit(); }

function sliderValtozas45(v) { simaArany45=parseInt(v); document.getElementById('sima-pct-lbl-45').textContent=simaArany45+'%'; document.getElementById('tk-pct-lbl-45').textContent=(100-simaArany45)+'%'; frissit(); }
function sliderValtozas32(v) { simaArany32=parseInt(v); document.getElementById('sima-pct-lbl-32').textContent=simaArany32+'%'; document.getElementById('tk-pct-lbl-32').textContent=(100-simaArany32)+'%'; frissit(); }
function resetArany45() { simaArany45=70; document.getElementById('sima-slider-45').value=70; sliderValtozas45(70); }
function resetArany32() { simaArany32=95; document.getElementById('sima-slider-32').value=95; sliderValtozas32(95); }

function ceiling(val,alap) { return Math.ceil(val/alap)*alap; }
function fmt(n) { return Number(n).toLocaleString('hu-HU'); }
function fmtFt(n) { return Number(n).toLocaleString('hu-HU')+' Ft'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// F≈ê FRISS√çT√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function frissit() {
  const tk45=100-simaArany45, tk32=100-simaArany32;
  const ft45=db45*cfg.szeletPerGomboc*cfg.szeletAr45;
  const ft32=db32*cfg.pizzaAr32;

  // Summary
  let sh='';
  if(mod!=='32') sh+=`<div class="summary-item"><div class="s-label">45cm pizza</div><div class="s-val">${fmt(db45)} db</div></div>
    <div class="summary-item"><div class="s-label">Szelet</div><div class="s-val">${fmt(db45*cfg.szeletPerGomboc)} db</div></div>
    <div class="summary-item highlight"><div class="s-label">45cm forgalom</div><div class="s-val">${fmtFt(ft45)}</div></div>`;
  if(mod==='kombi') sh+=`<div class="summary-sep"></div>`;
  if(mod!=='45') sh+=`<div class="summary-item"><div class="s-label">32cm pizza</div><div class="s-val">${fmt(db32)} db</div></div>
    <div class="summary-item highlight"><div class="s-label">32cm forgalom</div><div class="s-val">${fmtFt(ft32)}</div></div>`;
  if(mod==='kombi') sh+=`<div class="summary-sep"></div><div class="summary-item highlight"><div class="s-label">üèÜ √ñsszes</div><div class="s-val">${fmtFt(ft45+ft32)}</div></div>`;
  document.getElementById('summary-bar').innerHTML=sh;

  // Gomb√≥c k√°rty√°k
  if(mod!=='32') document.getElementById('gomboc-vals-45').innerHTML=
    `<div class="gv"><div class="glabel">Sima</div><div class="num">${Math.round(db45*simaArany45/100)}</div><div class="pct">${simaArany45}%</div></div>
    <div class="vs">vs</div><div class="gv tk"><div class="glabel">TK</div><div class="num">${Math.round(db45*tk45/100)}</div><div class="pct">${tk45}%</div></div>`;
  if(mod!=='45') document.getElementById('gomboc-vals-32').innerHTML=
    `<div class="gv g32"><div class="glabel">Sima</div><div class="num">${Math.round(db32*simaArany32/100)}</div><div class="pct">${simaArany32}%</div></div>
    <div class="vs">vs</div><div class="gv tk"><div class="glabel">TK</div><div class="num">${Math.round(db32*tk32/100)}</div><div class="pct">${tk32}%</div></div>`;

  // Pizza grid
  document.getElementById('pizza-grid').innerHTML = aktivPizzak().map(pz => {
    const d45=Math.round(db45*pz.arany/100), d32=Math.round(db32*pz.arany/100);
    let dbh='';
    if(mod==='45') dbh=`<div class="pizza-db45">${d45} db</div>`;
    else if(mod==='32') dbh=`<div class="pizza-db32">${d32} db</div>`;
    else dbh=`<div class="pizza-db45">${d45} db</div><div class="pizza-db32">${d32} db 32cm</div>`;
    return `<div class="pizza-card ${pz.custom?'custom':''}"><div><div class="pizza-name">${pz.nev}${pz.custom?'<span style="font-size:9px;background:#8E44AD;color:white;border-radius:3px;padding:1px 4px;margin-left:4px;">√öJ</span>':''}</div><div class="pizza-pct">${pz.arany}%</div></div><div class="pizza-dbs">${dbh}</div></div>`;
  }).join('');

  // Alapanyag t√°bla
  const anyagok = szamolAlapanyagok();
  let html='';
  // Gomb√≥c sorok el≈ësz√∂r
  html+=`<tr class="group-header group-gomboc"><td colspan="5">ü´ì Gomb√≥c</td></tr>`;
  const gombocSorok=[
    {nev: mod==='32'?`Sima gomb√≥c 32cm (${simaArany32}%)`:`Sima gomb√≥c${mod==='kombi'?' 45cm':''} (${simaArany45}%)`, egys:"db", ertek:Math.round(db45*simaArany45/100), alap:6, ae:"db", sor_class:"row-gomboc"},
    {nev: mod==='32'?`TK gomb√≥c 32cm (${tk32}%)`:`TK gomb√≥c${mod==='kombi'?' 45cm':''} (${tk45}%)`, egys:"db", ertek:Math.round(db45*tk45/100), alap:6, ae:"db", sor_class:"row-gomboc"},
  ];
  if(mod!=='45') {
    gombocSorok.push({nev:`Sima gomb√≥c 32cm (${simaArany32}%)`, egys:"db", ertek:Math.round(db32*simaArany32/100), alap:12, ae:"db", sor_class:"row-gomboc"});
    gombocSorok.push({nev:`TK gomb√≥c 32cm (${tk32}%)`, egys:"db", ertek:Math.round(db32*tk32/100), alap:8, ae:"db", sor_class:"row-gomboc"});
  }
  gombocSorok.forEach(a => {
    const ceilStr=`<span class="ceil">${fmt(ceiling(a.ertek,a.alap))} ${a.ae}</span>`;
    html+=`<tr class="${a.sor_class}"><td>${a.nev}</td><td>${a.egys}</td><td><span class="val">${fmt(a.ertek)}</span><span class="unit"> ${a.egys}</span></td><td>${fmt(a.alap)} ${a.ae}</td><td>${ceilStr}</td></tr>`;
  });

  // Fix alapanyagok
  const fixAnyagok = anyagok.filter(a => !a.custom);
  const egyebAnyagok = anyagok.filter(a => a.custom);

  if(fixAnyagok.length>0) {
    html+=`<tr class="group-header group-fix"><td colspan="5">üì¶ Alapanyagok</td></tr>`;
    fixAnyagok.forEach(a => {
      const ceilStr=a.alap!==null?`<span class="ceil">${fmt(ceiling(a.ertek,a.alap))} ${a.ae}</span>`:'<span class="dash">‚Äì</span>';
      const alapStr=a.alap!==null?`${fmt(a.alap)} ${a.ae}`:'<span class="dash">‚Äì</span>';
      html+=`<tr class="row-normal"><td>${a.nev}</td><td>${a.egys}</td><td><span class="val">${fmt(a.ertek)}</span><span class="unit"> ${a.egys}</span></td><td>${alapStr}</td><td>${ceilStr}</td></tr>`;
    });
  }

  if(egyebAnyagok.length>0) {
    html+=`<tr class="group-header group-egyeb-pizza"><td colspan="5">üÜï Egy√©ni pizza alapanyagok</td></tr>`;
    egyebAnyagok.forEach(a => {
      html+=`<tr class="row-egyeb-pizza"><td>${a.nev}</td><td>${a.egys}</td><td><span class="val">${fmt(a.ertek)}</span><span class="unit"> ${a.egys}</span></td><td><span class="dash">‚Äì</span></td><td><span class="dash">‚Äì</span></td></tr>`;
    });
  }

  document.getElementById('anyag-tabla').innerHTML=html;
  document.getElementById('footer-bar').textContent=`45cm: 1 gomb√≥c = ${cfg.szeletPerGomboc} szelet = ${fmtFt(cfg.szeletPerGomboc*cfg.szeletAr45)} ¬∑ 32cm: 1 pizza = ${fmtFt(cfg.pizzaAr32)} ¬∑ Receptek: 45cm teljes, 32cm fele`;
  document.getElementById('input-title').textContent=`üìä Mennyi √°ru kell? ¬∑ Profil: ${aktivProfil().nev}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); renderModalBody(); }
function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); receptSzerkesztoIdx=null; renderInputs(); frissit(); }
function setModalTab(t) {
  modalTab=t;
  ['arak','pizzak','profilok'].forEach(tab => {
    const el = document.getElementById('mtab-'+tab);
    if(el) el.classList.toggle('active', tab===t);
  });
  renderModalBody();
}
function renderModalBody() {
  if(modalTab==='arak') renderArakTab();
  else if(modalTab==='pizzak') renderPizzakTab();
  else renderProfilokTab();
}

function renderArakTab() {
  document.getElementById('modal-body').innerHTML=`
    <div class="settings-grid">
      <div class="setting-item"><label>üçï 45cm szelet √°ra (Ft)</label>
        <input type="number" id="set-szelet-ar" value="${cfg.szeletAr45}" min="1" oninput="cfgValtozas()">
        <span class="s-hint">1 szelet √°ra forintban</span></div>
      <div class="setting-item"><label>ü´ì 32cm eg√©sz pizza √°ra (Ft)</label>
        <input type="number" id="set-pizza-ar32" value="${cfg.pizzaAr32}" min="1" oninput="cfgValtozas()">
        <span class="s-hint">1 eg√©sz pizza √°ra forintban</span></div>
      <div class="setting-item"><label>‚úÇÔ∏è Szelet / gomb√≥c (db)</label>
        <input type="number" id="set-szelet-per-gomboc" value="${cfg.szeletPerGomboc}" min="1" max="20" oninput="cfgValtozas()">
        <span class="s-hint">H√°ny szeletre v√°gj√°k a 45cm-es pizz√°t</span></div>
      <div class="setting-item" style="background:#f7f9fc;border-radius:8px;padding:14px;">
        <label>üìä √ñsszefoglal√≥</label>
        <div style="font-size:13px;color:#555;margin-top:6px;line-height:1.9;">
          1 gomb√≥c (45cm) = <strong>${fmtFt(cfg.szeletPerGomboc*cfg.szeletAr45)}</strong><br>
          1 szelet (45cm) = <strong>${fmtFt(cfg.szeletAr45)}</strong><br>
          1 pizza (32cm) = <strong>${fmtFt(cfg.pizzaAr32)}</strong></div></div>
    </div>`;
}

function cfgValtozas() {
  cfg.szeletAr45=parseInt(document.getElementById('set-szelet-ar').value)||cfg.szeletAr45;
  cfg.pizzaAr32=parseInt(document.getElementById('set-pizza-ar32').value)||cfg.pizzaAr32;
  cfg.szeletPerGomboc=parseInt(document.getElementById('set-szelet-per-gomboc').value)||cfg.szeletPerGomboc;
  renderArakTab();
}

// ‚îÄ‚îÄ Pizza tab ‚îÄ‚îÄ
function renderPizzakTab() {
  const ossz=osszeArany();
  const okE=Math.abs(ossz-100)<0.1;
  let h=`<div class="pizza-settings-header">
    <div>
      <div style="font-size:12px;color:#888;margin-bottom:4px;">Kapcsold ki amit nem k√≠n√°lsz ¬∑ √Åll√≠tsd be az ar√°nyokat ¬∑ Szerkeszd a recepteket</div>
      <div class="arany-ossz ${okE?'ok':'err'}">√ñsszes ar√°ny: ${ossz}% ${okE?'‚úì':'‚ö† Normaliz√°lj!'}</div>
    </div>
    <button class="norm-btn" onclick="normalizal()">‚öñÔ∏è Normaliz√°l√°s 100%-ra</button>
  </div>`;

  pizzak.forEach((p,i) => {
    h+=`<div class="pizza-setting-row">
      <label class="pizza-toggle"><input type="checkbox" ${p.aktiv?'checked':''} onchange="togglePizza(${i})"><span class="toggle-slider"></span></label>
      <span class="pizza-setting-name ${p.aktiv?'':'disabled'}">${p.nev}${p.custom?'<span class="custom-badge">√öJ</span>':''}</span>
      <div class="arany-input-wrap">
        <input class="arany-input" type="number" value="${p.arany}" min="0" max="100" step="0.01" ${p.aktiv?'':'disabled'} oninput="aranyValtozas(${i},this.value)">
        <span style="font-size:12px;color:#888;">%</span>
      </div>
      <button class="pizza-recept-btn" onclick="toggleReceptSzerkeszto(${i})">üßæ Recept ${receptSzerkesztoIdx===i?'‚ñ≤':'‚ñº'}</button>
      ${p.custom?`<button class="btn btn-danger btn-xs" onclick="pizzaTorles(${i})">üóë</button>`:''}
    </div>`;

    if(receptSzerkesztoIdx===i) {
      h+=`<div class="recept-form">
        <h4>üìã ${p.nev} ‚Äì recept szerkeszt√©se (45cm, grammban)</h4>
        ${p.recept.map((r,ri) => `
          <div class="recept-row">
            <select onchange="receptAnyagValtozas(${i},${ri},this.value)">
              ${alapanyagok.map(a=>`<option value="${a.nev}" ${a.nev===r.anyag?'selected':''}>${a.nev}</option>`).join('')}
              <option value="__uj__" ${r.anyag==='__uj__'?'selected':''}>+ √öj alapanyag...</option>
            </select>
            ${r.anyag==='__uj__'?`<input type="text" placeholder="Alapanyag neve" value="${r.ujNev||''}" oninput="receptUjNevValtozas(${i},${ri},this.value)" style="flex:2;border:1.5px solid #27ae60;border-radius:6px;padding:7px 10px;font-size:13px;outline:none;">`:''}
            <input type="number" value="${r.menny}" min="0" placeholder="menny" oninput="receptMennyValtozas(${i},${ri},this.value)">
            <span style="font-size:12px;color:#888;">${r.egys||'g'}</span>
            <button class="del-btn" onclick="receptSorTorles(${i},${ri})">‚úï</button>
          </div>`).join('')}
        <button class="add-anyag-btn" onclick="receptSorHozzaad(${i})">+ Alapanyag hozz√°ad√°sa</button>
      </div>`;
    }
  });

  // √öj pizza form
  h+=`<div class="new-pizza-form">
    <h4>‚ûï √öj pizza hozz√°ad√°sa</h4>
    <div class="form-row">
      <div class="form-field"><label>Pizza neve</label><input type="text" id="uj-nev" placeholder="pl. Caprese"></div>
      <div class="form-field" style="max-width:120px;"><label>Ar√°ny (%)</label><input type="number" id="uj-arany" value="1" min="0.01" max="100" step="0.01"></div>
    </div>
    <div id="uj-recept-sorok">
      <div class="recept-row">
        <select id="uj-anyag-0">
          ${alapanyagok.map(a=>`<option value="${a.nev}">${a.nev}</option>`).join('')}
          <option value="__uj__">+ √öj alapanyag...</option>
        </select>
        <input type="number" id="uj-menny-0" value="" min="0" placeholder="menny">
        <span style="font-size:12px;color:#888;">g</span>
      </div>
    </div>
    <button class="add-anyag-btn" onclick="ujReceptSorHozzaad()" style="margin-top:6px;">+ Alapanyag hozz√°ad√°sa</button>
    <div style="margin-top:12px;display:flex;gap:10px;">
      <button class="btn btn-success btn-sm" onclick="ujPizzaMent()">‚úì Pizza ment√©se</button>
      <div id="uj-hiba" style="color:#c0392b;font-size:12px;display:flex;align-items:center;"></div>
    </div>
  </div>`;

  document.getElementById('modal-body').innerHTML=h;
}

let ujReceptSorDb=1;

function ujReceptSorHozzaad() {
  const cont=document.getElementById('uj-recept-sorok');
  const i=ujReceptSorDb++;
  const div=document.createElement('div');
  div.className='recept-row';
  div.innerHTML=`<select id="uj-anyag-${i}">${alapanyagok.map(a=>`<option value="${a.nev}">${a.nev}</option>`).join('')}<option value="__uj__">+ √öj alapanyag...</option></select>
    <input type="number" id="uj-menny-${i}" value="" min="0" placeholder="menny">
    <span style="font-size:12px;color:#888;">g</span>
    <button class="del-btn" onclick="this.parentElement.remove()">‚úï</button>`;
  cont.appendChild(div);
}

function ujPizzaMent() {
  const nev=document.getElementById('uj-nev').value.trim();
  const arany=parseFloat(document.getElementById('uj-arany').value)||0;
  const hiba=document.getElementById('uj-hiba');

  if(!nev) { hiba.textContent='K√©rlek add meg a pizza nev√©t!'; return; }
  if(arany<=0) { hiba.textContent='Az ar√°nynak 0-n√°l nagyobbnak kell lennie!'; return; }
  if(pizzak.find(p=>p.nev.toLowerCase()===nev.toLowerCase())) { hiba.textContent='M√°r van ilyen nev≈± pizza!'; return; }

  const recept=[];
  let ri=0;
  while(document.getElementById(`uj-anyag-${ri}`)) {
    const anyagEl=document.getElementById(`uj-anyag-${ri}`);
    const mennyEl=document.getElementById(`uj-menny-${ri}`);
    if(anyagEl && mennyEl && mennyEl.value) {
      let anyagNev=anyagEl.value;
      if(anyagNev==='__uj__') {
        const ujNevEl=document.getElementById(`uj-ujnev-${ri}`);
        anyagNev=ujNevEl?ujNevEl.value.trim():'';
        if(!anyagNev) { ri++; continue; }
        // √öj alapanyag hozz√°ad√°sa a master list√°hoz
        if(!alapanyagok.find(a=>a.nev===anyagNev)) {
          alapanyagok.push({nev:anyagNev, egys:"g", alap:null, ae:null});
        }
      }
      recept.push({anyag:anyagNev, menny:parseFloat(mennyEl.value)||0, egys:"g"});
    }
    ri++;
  }

  pizzak.push({nev, arany, aktiv:true, custom:true, recept});
  aktivProfil().pizzak=pizzak;
  ujReceptSorDb=1;
  hiba.textContent='';
  renderPizzakTab();
  frissit();
}

function toggleReceptSzerkeszto(i) {
  receptSzerkesztoIdx = receptSzerkesztoIdx===i ? null : i;
  renderPizzakTab();
}

function togglePizza(i) { pizzak[i].aktiv=!pizzak[i].aktiv; aktivProfil().pizzak=pizzak; renderPizzakTab(); frissit(); }

function aranyValtozas(i,val) {
  pizzak[i].arany=Math.round(parseFloat(val)*100)/100||0;
  aktivProfil().pizzak=pizzak;
  const ossz=osszeArany(); const okE=Math.abs(ossz-100)<0.1;
  const el=document.querySelector('.arany-ossz');
  if(el){el.textContent=`√ñsszes ar√°ny: ${ossz}% ${okE?'‚úì':'‚ö† Normaliz√°lj!'}`; el.className=`arany-ossz ${okE?'ok':'err'}`;}
  frissit();
}

function pizzaTorles(i) {
  if(!confirm(`T√∂rl√∂d a(z) "${pizzak[i].nev}" pizz√°t?`)) return;
  pizzak.splice(i,1);
  aktivProfil().pizzak=pizzak;
  receptSzerkesztoIdx=null;
  renderPizzakTab(); frissit();
}

function receptAnyagValtozas(pi,ri,val) {
  pizzak[pi].recept[ri].anyag=val;
  if(val!=='__uj__') delete pizzak[pi].recept[ri].ujNev;
  renderPizzakTab();
}

function receptUjNevValtozas(pi,ri,val) { pizzak[pi].recept[ri].ujNev=val; }
function receptMennyValtozas(pi,ri,val) { pizzak[pi].recept[ri].menny=parseFloat(val)||0; frissit(); }

function receptSorHozzaad(pi) {
  pizzak[pi].recept.push({anyag:alapanyagok[0].nev, menny:0, egys:"g"});
  renderPizzakTab();
}

function receptSorTorles(pi,ri) {
  pizzak[pi].recept.splice(ri,1);
  renderPizzakTab(); frissit();
}

function normalizal() {
  const ak=aktivPizzak(); const ossz=ak.reduce((s,p)=>s+p.arany,0);
  if(ossz===0) return;
  ak.forEach(p=>p.arany=Math.round(p.arany/ossz*10000)/100);
  const diff=Math.round((100-aktivPizzak().reduce((s,p)=>s+p.arany,0))*100)/100;
  if(diff!==0&&ak.length>0) ak[0].arany=Math.round((ak[0].arany+diff)*100)/100;
  aktivProfil().pizzak=pizzak;
  renderPizzakTab(); frissit();
}

function renderProfilokTab() {
  let h = `<div style="margin-bottom:16px;">
    <div style="font-size:12px;color:#888;margin-bottom:12px;">V√°lts profilok k√∂z√∂tt, nevezd √°t ≈ëket, vagy hozz l√©tre √∫jat megl√©v≈ë alapj√°n.</div>
    <div class="profil-lista">`;

  profilok.forEach((p, i) => {
    const isAktiv = p.id === aktivProfilId;
    const isDefault = i === 0;
    h += `<div class="profil-sor ${isAktiv?'aktiv':''}">
      <input class="profil-nev-input" type="text" value="${p.nev}" oninput="profilAtnevez(${p.id}, this.value)" placeholder="Profil neve">
      ${isAktiv ? '<span class="profil-aktiv-badge">‚úì Akt√≠v</span>' : `<button class="btn btn-primary btn-xs" onclick="profilValtas(${p.id});renderProfilokTab()">Aktiv√°l√°s</button>`}
      ${!isDefault ? `<button class="btn btn-danger btn-xs" onclick="profilTorles(${p.id})">üóë</button>` : '<span class="profil-default-badge">Alap√©rtelmezett</span>'}
    </div>`;
  });

  h += `</div></div>
  <div class="uj-profil-form">
    <h4>‚ûï √öj profil l√©trehoz√°sa</h4>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
      <div class="form-field" style="flex:2;min-width:160px;">
        <label>Profil neve</label>
        <input type="text" id="uj-profil-nev" placeholder="pl. Rendezv√©ny, H√©tv√©ge...">
      </div>
      <div class="form-field" style="flex:2;min-width:160px;">
        <label>M√°sol√°s ebb≈ël a profilb√≥l</label>
        <select id="uj-profil-forr√°s" style="border:2px solid #dde3f0;border-radius:7px;padding:8px 10px;font-size:13px;outline:none;width:100%;">
          ${profilok.map(p => `<option value="${p.id}">${p.nev}</option>`).join('')}
        </select>
      </div>
    </div>
    <div style="font-size:12px;color:#888;margin-bottom:10px;">Az √∫j profil a kiv√°lasztott profil pizz√°it √©s ar√°nyait m√°solja ‚Äì ut√°na szabadon szerkesztheted.</div>
    <button class="btn btn-success btn-sm" onclick="ujProfilMent()">‚úì Profil l√©trehoz√°sa</button>
    <span id="uj-profil-hiba" style="color:#c0392b;font-size:12px;margin-left:10px;"></span>
  </div>`;

  document.getElementById('modal-body').innerHTML = h;
}

function profilAtnevez(id, nev) {
  const p = profilok.find(p => p.id === id);
  if(p) { p.nev = nev; renderProfilBar(); }
}

function profilTorles(id) {
  const p = profilok.find(pr => pr.id === id);
  if(!p) return;
  if(!confirm(`T√∂rl√∂d a(z) "${p.nev}" profilt?`)) return;
  if(id === aktivProfilId) {
    aktivProfilId = profilok[0].id;
    pizzak = aktivProfil().pizzak;
  }
  profilok = profilok.filter(pr => pr.id !== id);
  renderProfilBar(); renderProfilokTab(); frissit();
}

function ujProfilMent() {
  const nev = document.getElementById('uj-profil-nev').value.trim();
  const forrasId = parseFloat(document.getElementById('uj-profil-forr√°s').value);
  const hiba = document.getElementById('uj-profil-hiba');
  if(!nev) { hiba.textContent = 'Add meg a profil nev√©t!'; return; }
  if(profilok.find(p => p.nev.toLowerCase() === nev.toLowerCase())) { hiba.textContent = 'M√°r van ilyen nev≈± profil!'; return; }
  const forras = profilok.find(p => p.id === forrasId) || profilok[0];
  const ujProfil = ujProfilAdat(nev, forras.pizzak);
  profilok.push(ujProfil);
  hiba.textContent = '';
  profilValtas(ujProfil.id);
  renderProfilokTab();
}

function resetAll() {
  if(!confirm('Vissza√°ll√≠tod az √∂sszes be√°ll√≠t√°st az alap√©rtelmezettre? (Minden profil t√∂rl≈ëdik!)')) return;
  cfg={...DEFAULTS};
  alapanyagok=defaultAlapanyagok.map(a=>({...a}));
  const alap = ujProfilAdat('√Åltal√°nos', defaultPizzak);
  profilok = [alap];
  aktivProfilId = alap.id;
  pizzak = aktivProfil().pizzak;
  receptSzerkesztoIdx=null;
  renderProfilBar(); renderModalBody(); frissit();
}

// Init
renderProfilBar();
renderInputs(); db45=100; frissit();
</script>
</body>
</html>
